<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Plataforma de Pago</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
</head>
<body class="bg-gray-100">
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar (Desktop) -->
    <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 hidden md:flex md:flex-col">
        <!-- Header Sidebar -->
        <div class="h-16 flex items-center gap-3 px-4 border-b border-gray-200">
            <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" aria-label="Menú">
                <i class="lni lni-grid-alt text-xl text-gray-700"></i>
            </button>
            <a href="/dashboardLog" class="text-lg font-semibold text-gray-800">Menu</a>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 px-3">
            <ul class="space-y-1">
                <li>
                    <a href="/dashboardLog" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-home text-xl"></i>
                        <span class="font-medium">Inicio</span>
                    </a>
                </li>
                <li>
                    <a href="/sobreNosotrosLog" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-users text-xl"></i>
                        <span class="font-medium">Nosotros</span>
                    </a>
                </li>
                <li>
                    <a href="/productos" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-package text-xl"></i>
                        <span class="font-medium">Productos</span>
                    </a>
                </li>
                <li>
                    <a href="/pagos" class="flex items-center gap-3 px-3 py-2.5 bg-blue-50 text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-credit-cards text-xl"></i>
                        <span class="font-medium">Pagos</span>
                    </a>
                </li>

                <li>
                    <a href="/contactanosLog" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-envelope text-xl"></i>
                        <span class="font-medium">Contáctanos</span>
                    </a>
                </li>

            </ul>
        </nav>

        <!-- Sidebar Footer -->
        <div class="border-t border-gray-200 p-3" sec:authorize="isAuthenticated()">
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="w-full flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors">
                    <i class="lni lni-exit text-xl"></i>
                    <span class="font-medium">Salir</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Mobile Sidebar Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

    <!-- Mobile Sidebar -->
    <aside id="mobileSidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 transform -translate-x-full transition-transform duration-300 z-50 md:hidden flex flex-col">
        <!-- Sidebar Header -->
        <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <i class="lni lni-grid-alt text-xl text-gray-700"></i>
                <span class="text-lg font-semibold text-gray-800">Menu</span>
            </div>
            <button id="closeMobileSidebar" class="p-2 hover:bg-gray-100 rounded-lg" aria-label="Cerrar menú">
                <i class="lni lni-close text-xl text-gray-700"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-4 px-3">
            <ul class="space-y-1">
                <li>
                    <a href="/dashboardLog" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-home text-xl"></i>
                        <span class="font-medium">Inicio</span>
                    </a>
                </li>
                <li>
                    <a href="/sobreNosotros" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-users text-xl"></i>
                        <span class="font-medium">Nosotros</span>
                    </a>
                </li>
                <li>
                    <a href="/productos" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-package text-xl"></i>
                        <span class="font-medium">Productos</span>
                    </a>
                </li>
                <li>
                    <a href="/pagos" class="flex items-center gap-3 px-3 py-2.5 bg-blue-50 text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-credit-cards text-xl"></i>
                        <span class="font-medium">Pagos</span>
                    </a>
                </li>

                <li>
                    <a href="/contactanos" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <i class="lni lni-envelope text-xl"></i>
                        <span class="font-medium">Contáctanos</span>
                    </a>
                </li>

            </ul>
        </nav>

        <!-- Sidebar Footer -->
        <div class="border-t border-gray-200 p-3" sec:authorize="isAuthenticated()">
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="w-full flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors">
                    <i class="lni lni-exit text-xl"></i>
                    <span class="font-medium">Salir</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-6 flex-shrink-0">
            <div class="flex items-center gap-3">
                <button id="openMobileSidebar" class="p-2 hover:bg-gray-100 rounded-lg md:hidden" aria-label="Abrir menú">
                    <i class="lni lni-menu text-xl text-gray-700"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">La Granja</h1>
            </div>

            <!-- Header Right -->
            <div class="flex items-center gap-3">
                <!-- Si NO está autenticado -->
                <div sec:authorize="isAnonymous()">
                    <a th:href="@{/login}" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Inicia sesión
                    </a>
                </div>

                <!-- Si está autenticado -->
                <div sec:authorize="isAuthenticated()" class="flex items-center gap-3">
                    <span class="hidden sm:inline-block px-3 py-1 bg-green-500 text-white text-sm rounded-full">Sesión iniciada</span>
                    <span class="font-semibold text-gray-700">Hola, <span sec:authentication="name">Usuario</span></span>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="px-3 md:px-4 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg flex items-center gap-2 transition-colors text-sm md:text-base font-medium">
                            <span class="hidden sm:inline">Cerrar sesión</span>
                            <i class="lni lni-exit"></i>
                        </button>
                    </form>
                </div>
            </div>
        </header>

        <!-- Payment Form -->
        <main class="flex-grow overflow-y-auto p-6 md:p-8">
            <div class="max-w-2xl mx-auto">
                <form th:action="@{/pagos}" th:object="${pago}" method="post" class="space-y-8">
                    <!-- Payment Method Section -->
                    <div>
                        <div th:if="${param.success}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6" role="alert">
                            ¡Pago procesado y guardado exitosamente!
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-6">Método de pago</h2>
                            <div class="mb-4">
                                <label for="nombreTitular" class="block text-gray-700 font-semibold mb-2">Nombre del Titular</label>
                                <input type="text" id="nombreTitular" th:field="*{nombreTitular}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                            </div>
                            <div class="mb-4">
                                <label for="numeroTarjeta" class="block text-gray-700 font-semibold mb-2">Número de Tarjeta</label>
                                <input type="text" id="numeroTarjeta" th:field="*{numeroTarjeta}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required />
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="mb-4">
                                    <label for="fechaExpiracion" class="block text-gray-700 font-semibold mb-2">Fecha de Expiración</label>
                                    <input type="text" id="fechaExpiracion" th:field="*{fechaExpiracion}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="MM/AA" maxlength="5" required />
                                </div>
                                <div class="mb-4">
                                    <label for="cvv" class="block text-gray-700 font-semibold mb-2">CVV</label>
                                    <input type="text" id="cvv" th:field="*{cvv}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="123" maxlength="4" required />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Section -->
                    <div>
                        <div class="bg-white p-8 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Resumen del pedido</h3>

                            <div id="cart-summary" class="space-y-2 mb-4">
                                <!-- Los productos del carrito se insertarán aquí -->
                            </div>

                            <hr class="my-4" />

                            <div class="flex justify-between font-bold text-lg mb-4">
                                <span>Total a Pagar:</span>
                                <span id="summary-total">S/ 0.00</span>
                            </div>

                            <!-- Campo oculto para el monto total que se envía con el formulario -->
                            <input type="hidden" step="0.01" id="monto" th:field="*{monto}" required />

                            <div class="flex flex-col gap-4">
                                <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                                    Confirmar y pagar
                                </button>
                                <a th:href="@{/productos}" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold text-center hover:bg-gray-300 transition-colors">
                                    Volver a productos
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>

<!-- Scripts -->
<script>
    // Toggle Sidebar móvil
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const openMobileSidebar = document.getElementById('openMobileSidebar');
    const closeMobileSidebar = document.getElementById('closeMobileSidebar');

    function openSidebar() {
        mobileSidebar.classList.remove('-translate-x-full');
        mobileOverlay.classList.remove('hidden');
    }
    function closeSidebar() {
        mobileSidebar.classList.add('-translate-x-full');
        mobileOverlay.classList.add('hidden');
    }

    if (openMobileSidebar) openMobileSidebar.addEventListener('click', openSidebar);
    if (closeMobileSidebar) closeMobileSidebar.addEventListener('click', closeSidebar);
    if (mobileOverlay) mobileOverlay.addEventListener('click', closeSidebar);

    // ============================================
    // SCRIPT DE PAGOS - INTEGRADO
    // ============================================

    // Función para obtener parámetros de la URL
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Función para formatear precio en soles
    function formatPrice(price) {
        return `S/ ${parseFloat(price).toFixed(2)}`;
    }

    // Cargar las cantidades desde localStorage (solo mapping id->qty)
    function loadQuantities() {
        try {
            return JSON.parse(localStorage.getItem('cartQty') || '{}');
        } catch (e) {
            console.error('Error al cargar las cantidades del carrito:', e);
            return {};
        }
    }

    // Calcular totales a partir de items [{name, price, qty}]
    function calculateTotalsFromItems(items) {
        const subtotal = items.reduce((sum, item) => sum + (item.qty * Number(item.price)), 0);
        const shipping = subtotal > 120 ? 0 : (items.length > 0 ? 8 : 0);
        const total = subtotal + shipping;
        return { subtotal, shipping, total };
    }

    // Renderizar resumen del carrito: obtiene cantidades de localStorage y metadatos desde /api/products
    async function renderCartSummary() {
        const quantities = loadQuantities();
        const ids = Object.keys(quantities);
        const summaryContainer = document.getElementById('cart-summary');
        const totalElement = document.getElementById('summary-total');
        const montoInput = document.getElementById('monto');

        summaryContainer.innerHTML = '';
        if (ids.length === 0) {
            summaryContainer.innerHTML = `
                <div class="text-gray-500 text-center py-4">
                    <p>No hay productos en el carrito</p>
                </div>
            `;
            totalElement.textContent = formatPrice(0);
            if (montoInput) montoInput.value = '0.00';
            return;
        }

        // Cargamos todos los productos y los filtramos (más simple que pedir uno por uno)
        let products = [];
        try{
            const res = await fetch('/api/products');
            if(!res.ok) throw new Error('Error fetching products');
            products = await res.json();
        }catch(e){
            console.error('No se pudo cargar productos para el resumen', e);
            summaryContainer.innerHTML = '<p class="text-sm text-red-600">No se pudo cargar la información de productos.</p>';
            return;
        }

        // Construimos items con metadata
        const items = ids.map(id => {
            const p = products.find(pp => String(pp.id) === String(id));
            const qty = quantities[id];
            return p ? { id: p.id, name: p.name, price: p.price, qty } : null;
        }).filter(Boolean);

        const { subtotal, shipping, total } = calculateTotalsFromItems(items);

        // Renderizar cada producto
        items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'flex justify-between text-gray-700 py-2 border-b';
            itemElement.innerHTML = `
                <div class="flex-1">
                    <p class="font-medium">${item.name}</p>
                    <p class="text-sm text-gray-500">Cantidad: ${item.qty} × ${formatPrice(item.price)}</p>
                </div>
                <div class="font-semibold">
                    ${formatPrice(item.qty * Number(item.price))}
                </div>
            `;
            summaryContainer.appendChild(itemElement);
        });

        // Agregar subtotal y envío
        summaryContainer.innerHTML += `
            <div class="flex justify-between text-gray-700 py-2">
                <span>Subtotal:</span>
                <span>${formatPrice(subtotal)}</span>
            </div>
            <div class="flex justify-between text-gray-700 py-2">
                <span>Envío:</span>
                <span class="${shipping === 0 ? 'text-green-600 font-semibold' : ''}">${shipping === 0 ? '¡Gratis!' : formatPrice(shipping)}</span>
            </div>
        `;

        // Actualizar total
        totalElement.textContent = formatPrice(total);

        // Actualizar campo oculto del formulario
        if (montoInput) {
            montoInput.value = total.toFixed(2);
        }
    }

    // Inicializar cuando cargue la página
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si hay un total en la URL (viene del carrito)
        const totalFromUrl = getUrlParameter('total');

        if (totalFromUrl && parseFloat(totalFromUrl) > 0) {
            // Si viene de la URL, usar ese valor
            const total = parseFloat(totalFromUrl);
            document.getElementById('summary-total').textContent = formatPrice(total);
            const montoInput = document.getElementById('monto');
            if (montoInput) {
                montoInput.value = total.toFixed(2);
            }
        }

        // Siempre renderizar el resumen del carrito completo
        renderCartSummary();

        // Validación del formulario
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const monto = parseFloat(document.getElementById('monto').value);

                if (monto <= 0) {
                    e.preventDefault();
                    alert('No hay productos en el carrito para procesar el pago.');
                    return false;
                }

                // Validar campos de tarjeta
                const numeroTarjeta = document.getElementById('numeroTarjeta').value.replace(/\s/g, '');
                if (numeroTarjeta.length < 13 || numeroTarjeta.length > 19) {
                    e.preventDefault();
                    alert('Número de tarjeta inválido. Debe tener entre 13 y 19 dígitos.');
                    return false;
                }

                const cvv = document.getElementById('cvv').value;
                if (cvv.length < 3 || cvv.length > 4) {
                    e.preventDefault();
                    alert('CVV inválido. Debe tener 3 o 4 dígitos.');
                    return false;
                }

                // Validar fecha de expiración
                const fechaExp = document.getElementById('fechaExpiracion').value;
                const fechaRegex = /^(0[1-9]|1[0-2])\/\d{2}$/;
                if (!fechaRegex.test(fechaExp)) {
                    e.preventDefault();
                    alert('Fecha de expiración inválida. Use el formato MM/AA.');
                    return false;
                }
            });
        }

        // Formatear número de tarjeta mientras se escribe
        const numeroTarjetaInput = document.getElementById('numeroTarjeta');
        if (numeroTarjetaInput) {
            numeroTarjetaInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
        }

        // Formatear fecha de expiración
        const fechaExpiracionInput = document.getElementById('fechaExpiracion');
        if (fechaExpiracionInput) {
            fechaExpiracionInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.slice(0, 2) + '/' + value.slice(2, 4);
                }
                e.target.value = value;
            });
        }

        // Solo números en CVV
        const cvvInput = document.getElementById('cvv');
        if (cvvInput) {
            cvvInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
            });
        }
    });
</script>
</body>
</html>